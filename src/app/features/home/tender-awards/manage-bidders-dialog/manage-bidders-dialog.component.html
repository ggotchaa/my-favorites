<h2 mat-dialog-title>Manage Approvers</h2>
<mat-dialog-content>
  <p class="dialog-subtitle">
    Review the current approvers and delegates assigned to this report. Use Add Approvers to include new approvers
    and optionally assign a delegate to them.
  </p>

  <div class="selected-approvers" *ngIf="hasEntries; else emptyState">
    <div class="selected-header" role="row">
      <div class="column approver" role="columnheader">Approver</div>
      <div class="column endorser" role="columnheader">Endorser</div>
      <div class="column delegate" role="columnheader">Delegate</div>
      <div class="column actions" role="columnheader">Actions</div>
    </div>

    <div class="selected-row" role="row" *ngFor="let entry of entries; trackBy: trackByUserId">
      <div class="column approver" role="cell">
        <span class="approver-name">{{ entry.name }}</span>
      </div>
      <div class="column endorser" role="cell">
        <mat-checkbox [checked]="entry.isEndorser" (change)="toggleEndorser(entry, !!$event.checked)">
          Endorser
        </mat-checkbox>
      </div>
      <div class="column delegate" role="cell">
        <mat-form-field appearance="fill" class="delegate-select">
          <mat-label>Delegate</mat-label>
          <mat-select [value]="entry.delegateUserId" (selectionChange)="updateDelegate(entry, $event.value)">
            <mat-option [value]="null">No delegate</mat-option>
            <mat-option *ngFor="let delegate of availableDelegateOptions" [value]="delegate.objectId">
              {{ delegate.displayName || delegate.objectId }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="column actions" role="cell">
        <button mat-icon-button color="warn" type="button" aria-label="Remove approver" (click)="removeEntry(entry)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <ng-template #emptyState>
    <p class="empty-state">No approvers have been assigned to this report yet.</p>
  </ng-template>

  <div class="add-approvers">
    <button mat-stroked-button color="primary" type="button" (click)="startAddApprovers()" [disabled]="isLoadingOptions">
      <mat-icon>person_add</mat-icon>
      Add Approvers
    </button>
  </div>

  <div class="selection-panel" *ngIf="isAddingApprovers">
    <div *ngIf="isLoadingOptions" class="loading-state">Loading available approversâ€¦</div>
    <div *ngIf="!isLoadingOptions && loadOptionsError" class="error-state">
      Unable to load approver and delegate lists. Please try again.
    </div>

    <div *ngIf="!isLoadingOptions && !loadOptionsError" class="selection-grid">
      <div class="selection-column">
        <h3>Approvers</h3>
        <p *ngIf="availableApproverOptions.length === 0" class="empty-message">
          All available approvers are already assigned to this report.
        </p>
        <mat-selection-list
          *ngIf="availableApproverOptions.length"
          [multiple]="true"
          (selectionChange)="handleApproverSelection($event)"
        >
          <mat-list-option
            *ngFor="let option of availableApproverOptions"
            [value]="option.objectId"
            [selected]="selectedApproverIds.has(option.objectId)"
          >
            {{ option.displayName || option.objectId }}
          </mat-list-option>
        </mat-selection-list>
      </div>

      <div class="selection-column">
        <h3>Delegates</h3>
        <mat-selection-list
          class="delegate-selection"
          [multiple]="true"
          (selectionChange)="handleDelegateSelection($event)"
        >
          <mat-list-option
            [value]="null"
            [selected]="selectedDelegateIds.has(null)"
          >
            No delegate
          </mat-list-option>
          <mat-list-option
            *ngFor="let delegate of availableDelegateOptions"
            [value]="delegate.objectId"
            [selected]="selectedDelegateIds.has(delegate.objectId)"
          >
            {{ delegate.displayName || delegate.objectId }}
          </mat-list-option>
        </mat-selection-list>
      </div>
    </div>

    <div class="selection-actions">
      <button mat-button type="button" (click)="cancelAddApprovers()">Cancel</button>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="confirmAddApprovers()"
        [disabled]="!canConfirmSelection"
      >
        Add Selected
      </button>
    </div>
  </div>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button type="button" (click)="close()">Cancel</button>
  <button mat-raised-button color="primary" type="button" (click)="save()" [disabled]="disableSave">
    Save
  </button>
</mat-dialog-actions>
