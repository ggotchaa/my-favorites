<mat-card class="material-card awards-header">
  <div class="header-main">
    <div class="header-error" *ngIf="viewProposalsError">{{ viewProposalsError }}</div>
    <div class="header-info">
      <h2>Tender Award Analysis {{ displayMonth }} {{ displayYear }}</h2>
      <p>Creator: {{ reportCreatedBy || reportSummary?.createdBy || '—' }}</p>
      <div class="header-status" *ngIf="(reportStatus || reportSummary?.status) as resolvedStatus">
        <span class="status-label">Status:</span>
        <span class="status-badge" [ngClass]="statusClass(resolvedStatus)">
          {{ resolvedStatus }}
        </span>
      </div>
    </div>
    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="viewProposals()"
        [disabled]="isViewingProposals"
      >
        <mat-icon *ngIf="isViewingProposals" class="loading-icon">autorenew</mat-icon>
        <span>{{ isViewingProposals ? 'Loading…' : 'View Proposals' }}</span>
      </button>
      <button
        mat-stroked-button
        type="button"
        (click)="calculateRollingFactor()"
        [disabled]="!isActiveStatus"
        [style]="isActiveStatus ? '' : 'cursor: not-allowed; pointer-events: none; background-color: #ccc; opacity: 0.6;'"
        *ngIf="isLpgCoordinator"
      >
        <div class="calculate-label">
          <ng-container *ngIf="isCalculatingRollingFactor; else calculateIcon">
            <mat-icon class="loading-icon">autorenew</mat-icon>
          </ng-container>
          <ng-template #calculateIcon>
            <mat-icon>calculate</mat-icon>
          </ng-template>
          <span>{{ isCalculatingRollingFactor ? 'Calculating…' : 'Calculate 12 months RLF' }}</span>
        </div>
      </button>
    </div>

  </div>
  <div class="tab-row">
    <button
      *ngIf="canViewInitiateTab"
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'Initiate'"
      (click)="navigateToTab('Initiate')"
    >
      Initiate
    </button>
    <button
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'History'"
      (click)="navigateToTab('History')"
    >
      History
    </button>
    <button
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'Active'"
      [disabled]="isHistoryAnalyzedStatus"
      (click)="navigateToTab('Active')"
    >
      Active
    </button>
  </div>
</mat-card>

<ng-container [ngSwitch]="activeTab">
  <mat-card *ngSwitchCase="'Initiate'" class="material-card initiate-card">
    <h3 class="initiate-title">Tender award analysis report details</h3>

    <div class="step-grid">
      <div
        class="step-card step-card--collect has-arrow"
        [ngClass]="{ 'step-card--completed': isCollectionCompleted }"
      >
        <span class="step-badge">1</span>
        <h4>Data Collection</h4>
        <p>Gather all required documents and information needed for processing.</p>

        <div class="step-form">
          <div class="step-form__row">
            <mat-form-field appearance="fill">
              <mat-label>Select Month</mat-label>
              <mat-select
                [(ngModel)]="collectionForm.month"
                name="collectionMonth"
                [disabled]="isReadOnlyView || isCollectionLoading || isCollectionCompleted"
                (selectionChange)="onCollectionPeriodChange()"
              >
                <mat-option *ngFor="let month of monthOptions" [value]="month">
                  {{ month }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Select Year</mat-label>
              <mat-select
                [(ngModel)]="collectionForm.year"
                name="collectionYear"
                [disabled]="isReadOnlyView || isCollectionLoading || isCollectionCompleted"
                (selectionChange)="onCollectionPeriodChange()"
              >
                <mat-option *ngFor="let year of yearOptions" [value]="year">
                  {{ year }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="step-form__row">
            <mat-form-field appearance="fill">
              <mat-label>Entry Price for Propane</mat-label>
              <input
                matInput
                type="number"
                name="entryPricePropane"
                [(ngModel)]="collectionForm.entryPricePropane"
                [disabled]="isReadOnlyView || isEntryPricesLoading"
              />
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>Benchmark for Butane</mat-label>
              <input
                matInput
                type="number"
                name="benchmarkButane"
                [(ngModel)]="collectionForm.benchmarkButane"
                [disabled]="isReadOnlyView || isEntryPricesLoading"
              />
            </mat-form-field>
          </div>
          <div *ngIf="isEntryPricesLoading" class="step-hint">Loading entry prices…</div>
          <div *ngIf="entryPricesError" class="step-feedback step-feedback--error">
            {{ entryPricesError }}
          </div>
        </div>

        <button
          mat-raised-button
          color="primary"
          type="button"
          class="step-action"
          (click)="startDataCollection()"
          [disabled]="isReadOnlyView || !canStartCollection"
        >
          <ng-container *ngIf="isCollectionLoading">Processing…</ng-container>
          <ng-container *ngIf="!isCollectionLoading && !isCollectionCompleted">Next</ng-container>
          <ng-container *ngIf="isCollectionCompleted">Completed</ng-container>
        </button>

        <div *ngIf="isCheckingActiveReports" class="step-hint">Checking for active reports…</div>
        <div *ngIf="hasBlockingActiveReport" class="step-feedback step-feedback--error">
          Complete the active report before starting a new flow.
        </div>
        <div *ngIf="activeReportCheckError" class="step-feedback step-feedback--error">
          {{ activeReportCheckError }}
        </div>
        <div *ngIf="collectionError" class="step-feedback step-feedback--error">
          {{ collectionError }}
        </div>
      </div>

      <div
        class="step-card step-card--process has-arrow"
        [ngClass]="{
          'step-card--locked': !isProcessingAvailable && !isProcessingCompleted,
          'step-card--completed': isProcessingCompleted
        }"
      >
        <span class="step-badge">2</span>
        <h4>Processing</h4>
        <p>Analyze and process the collected data through our system.</p>

        <button
          mat-raised-button
          color="primary"
          type="button"
          class="step-action"
          (click)="analyzeAndProcess()"
          [disabled]="!canAnalyzeAndProcess"
        >
          <ng-container *ngIf="isProcessingLoading">Processing…</ng-container>
          <ng-container *ngIf="!isProcessingLoading && !isProcessingCompleted"
            >Analyze and Process</ng-container
          >
          <ng-container *ngIf="isProcessingCompleted">Completed</ng-container>
        </button>

        <div *ngIf="processingResultMessage" class="step-feedback step-feedback--success">
          {{ processingResultMessage }}
        </div>

        <div
          *ngIf="!isProcessingAvailable && !isProcessingCompleted"
          class="step-hint"
        >
          Complete data collection to enable processing.
        </div>

        <div *ngIf="processingError" class="step-feedback step-feedback--error">
          {{ processingError }}
        </div>
      </div>

      <div
        class="step-card step-card--complete"
        [ngClass]="{
          'step-card--locked': !isCompletionAvailable,
          'step-card--completed': isProcessingCompleted
        }"
      >
        <span class="step-badge">3</span>
        <h4>Completion</h4>
        <p>Review results and finalize the awarded nominations.</p>

        <button
          mat-raised-button
          color="primary"
          type="button"
          class="step-action"
          (click)="completeBiddingReport()"
          [disabled]="!canGetProposals || isLoadingProposals"
        >
          <ng-container *ngIf="isLoadingProposals">Processing…</ng-container>
          <ng-container *ngIf="!isLoadingProposals">Get Proposals</ng-container>
        </button>

        <div *ngIf="!isCompletionAvailable" class="step-hint">
          Analyze shipments to unlock proposals.
        </div>

        <div *ngIf="proposalsSuccessMessage" class="step-feedback step-feedback--success">
          {{ proposalsSuccessMessage }}
        </div>

        <div *ngIf="proposalsError" class="step-feedback step-feedback--error">
          {{ proposalsError }}
        </div>
      </div>
    </div>

    <!-- <p class="formula">
      Calculating Performance(%) = (Lifted PR + Lifted BT)/(Nominated PR + Nominated BT)
    </p> -->

    <mat-card class="material-card progress-card">
      <div class="progress-header">
        <strong>Current Progress</strong>
        <span class="progress-meta">Step {{ progressStep }} of 3</span>
      </div>
      <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>
      <div class="progress-actions">
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="analyzeAndProcess()"
          [disabled]="!canAnalyzeAndProcess"
        >
          Analyze and Process
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="completeBiddingReport()"
          [disabled]="!canGetProposals || isLoadingProposals"
        >
          {{ isLoadingProposals ? 'Processing…' : 'Get Proposals' }}
        </button>
      </div>
    </mat-card>
  </mat-card>

  <mat-card *ngSwitchCase="'History'" class="material-card history-card">
    <h3>Historical Data</h3>
    <div class="app-table-card">
      <div *ngIf="isLoadingHistory" class="history-state">Loading history…</div>
      <div *ngIf="!isLoadingHistory && historyLoadError" class="history-state history-state--error">
        Unable to load history for this report.
      </div>
      <div
        *ngIf="!isLoadingHistory && !historyLoadError && historyDataSource.data.length === 0"
        class="history-state"
      >
        {{ historyReportId ? 'No history entries available.' : 'Select a report to view history.' }}
      </div>
      <div
        class="table-container app-table-container"
        *ngIf="!isLoadingHistory && !historyLoadError && historyDataSource.data.length"
      >
        <table
          mat-table
          [dataSource]="historyDataSource"
          class="mat-elevation-z0 app-data-table tender-table"
          matSort
          [matSortDisableClear]="true"
          #historySort="matSort"
        >
          <ng-container *ngFor="let column of historyColumns" [matColumnDef]="column.key">
            <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
            <td mat-cell *matCellDef="let row">
              <ng-container [ngSwitch]="column.key">
                <ng-container *ngSwitchCase="'status'">
                  <button
                    type="button"
                    class="status-cell-btn"
                    (click)="openStatusDialog(row, historyDataSource, historyStatusOptions)"
                    [disabled]="isReadOnlyView || isStatusUpdating(row.id) || isPendingApprovalStatus"
                  >
                    <mat-icon *ngIf="isStatusUpdating(row.id)" class="loading-icon">autorenew</mat-icon>
                    <span class="status-badge" [ngClass]="statusClass(row.status)">
                      {{ row.status }}
                    </span>
                  </button>
                </ng-container>
                <ng-container *ngSwitchCase="'customerName'">
                  <button
                    mat-button
                    type="button"
                    class="history-link"
                    (click)="openHistoryCustomerDialog(row)"
                    [disabled]="historyCustomerLoadingId !== null"
                  >
                    <mat-icon
                      *ngIf="historyCustomerLoadingId === row.id || (historyCustomerLoadingId === -1 && row.id == null)"
                      class="loading-icon"
                    >
                      autorenew
                    </mat-icon>
                    <span>{{ row.customerName || '—' }}</span>
                  </button>
                </ng-container>
                <span *ngSwitchCase="'biddingMonth'">{{ formatHistoryMonth(row.biddingMonth) }}</span>
                <span *ngSwitchCase="'volumePR'">{{ row.volumePR | number: '1.0-0' }}</span>
                <span *ngSwitchCase="'volumeBT'">{{ row.volumeBT | number: '1.0-0' }}</span>
                <ng-container *ngSwitchCase="'additionalVolumePR'">
                  <input
                    matInput
                    type="number"
                    [ngModel]="row.additionalVolumePR"
                    (ngModelChange)="onHistoryAdditionalVolumeChange(row, 'additionalVolumePR', $event)"
                    [disabled]="isReadOnlyView || isPendingApprovalStatus"
                  />
                </ng-container>
                <ng-container *ngSwitchCase="'additionalVolumeBT'">
                  <input
                    matInput
                    type="number"
                    [ngModel]="row.additionalVolumeBT"
                    (ngModelChange)="onHistoryAdditionalVolumeChange(row, 'additionalVolumeBT', $event)"
                    [disabled]="isReadOnlyView || isPendingApprovalStatus"
                  />
                </ng-container>
                <span *ngSwitchCase="'finalAwardedPR'">{{ row.finalAwardedPR | number: '1.0-0' }}</span>
                <span *ngSwitchCase="'finalAwardedBT'">{{ row.finalAwardedBT | number: '1.0-0' }}</span>
                <span *ngSwitchCase="'takenPR'">{{ row.takenPR | number: '1.0-0' }}</span>
                <span *ngSwitchCase="'takenBT'">{{ row.takenBT | number: '1.0-0' }}</span>
                <span *ngSwitchCase="'oneMonthPerformanceScore'">{{ row.oneMonthPerformanceScore | number: '1.2-2' }}</span>
                <ng-container *ngSwitchCase="'comments'">
                  <textarea
                    matInput
                    class="table-textarea comment-textarea"
                    rows="1"
                    #historyCommentArea
                    [ngModel]="row.comments || ''"
                    (ngModelChange)="onHistoryCommentsChange(row, $event)"
                    (input)="autoResizeTextarea(historyCommentArea)"
                    [disabled]="isReadOnlyView || isPendingApprovalStatus"
                  ></textarea>
                </ng-container>
                <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
              </ng-container>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="historyDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: historyDisplayedColumns"></tr>
        </table>
      </div>
      <div
        class="history-actions"
        *ngIf="!isLoadingHistory && !historyLoadError && historyDataSource.data.length"
      >
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="saveHistoryChanges()"
            [disabled]="
              isReadOnlyView ||
              !hasHistoryPendingChanges ||
              isSavingHistoryChanges ||
              isPendingApprovalStatus
            "
          >
          <mat-icon *ngIf="isSavingHistoryChanges" class="loading-icon">autorenew</mat-icon>
          <span>{{ isSavingHistoryChanges ? 'Saving…' : 'Save History Changes' }}</span>
        </button>
      </div>
    </div>
  </mat-card>

  <div *ngSwitchCase="'Active'" class="active-view">
    <ng-container *ngIf="currentReportId; else noActiveReportSelected">
      <!-- Propane Table -->
      <section class="product-section" *ngIf="awardTables.propane.dataSource.data.length">
        <div class="product-section__header">
          <h3 class="product-section__title">{{ awardTables.propane.label }}</h3>
        </div>
        <div
          class="table-container table-container--scrollable"
          [class.table-container--saving]="isSavingChanges"
        >
          <div class="table-saving-overlay" *ngIf="isSavingChanges">
            <mat-icon class="loading-icon" aria-hidden="true">autorenew</mat-icon>
            <span>Saving changes…</span>
          </div>
          <table
            mat-table
            [dataSource]="awardTables.propane.dataSource"
            class="app-data-table tender-table"
            matSort
            [matSortDisableClear]="true"
            #propaneSort="matSort"
          >
              <ng-container *ngFor="let column of awardsColumns" [matColumnDef]="column.key">
                <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
                <td mat-cell *matCellDef="let row">
                  <ng-container [ngSwitch]="column.key">
                    <ng-container *ngSwitchCase="'status'">
                      <button
                        type="button"
                        class="status-cell-btn"
                        (click)="openActiveStatusDialog(row)"
                        [disabled]="isReadOnlyView || isStatusUpdating(row.id) || isPendingApprovalStatus"
                      >
                        <mat-icon *ngIf="isStatusUpdating(row.id)" class="loading-icon">autorenew</mat-icon>
                        <span class="status-badge" [ngClass]="statusClass(row.status)">
                          {{ row.status || 'Set status' }}
                        </span>
                      </button>
                    </ng-container>
                    <span *ngSwitchCase="'bidVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <span *ngSwitchCase="'awardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <ng-container *ngSwitchCase="'finalAwardedVolume'">
                      <input
                        matInput
                        class="table-input"
                        type="number"
                        min="0"
                        [ngModel]="row.finalAwardedVolume ?? ''"
                        (ngModelChange)="onFinalAwardedVolumeChange(row, $event)"
                        [ngModelOptions]="{ standalone: true }"
                        [disabled]="isReadOnlyView || isPendingApprovalStatus"
                      />
                    </ng-container>
                    <span *ngSwitchCase="'bidPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <span *ngSwitchCase="'differentialPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <span *ngSwitchCase="'rankPerPrice'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <span *ngSwitchCase="'rollingLiftFactor'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <ng-container *ngSwitchCase="'comments'">
                      <textarea
                        matInput
                        class="table-textarea comment-textarea"
                        #activeCommentArea
                        [ngModel]="row.comments ?? ''"
                        (ngModelChange)="onCommentChange(row, $event)"
                        (input)="autoResizeTextarea(activeCommentArea)"
                        [ngModelOptions]="{ standalone: true }"
                        rows="2"
                        placeholder="Add comment"
                        [disabled]="isReadOnlyView || isPendingApprovalStatus"
                      ></textarea>
                    </ng-container>
                    <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
                  </ng-container>
                </td>
              </ng-container>

            <tr mat-header-row *matHeaderRowDef="awardsDisplayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: awardsDisplayedColumns"></tr>
          </table>
        </div>

        <!-- Propane Summary -->
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-card__value">{{ propaneSummary.totalVolume | number: '1.0-0' }}</div>
            <div class="summary-card__label">Sum of bid volume for propane</div>
          </div>
          <div class="summary-card">
            <div class="summary-card__value">{{ propaneSummary.weightedAverage | number: '1.0-0' }}</div>
            <div class="summary-card__label">Weighted average for propane</div>
            <!-- weightedAvgPropanePrice weightedAvgButanePrice
: 
202.5
weightedAvgPropanePrice
: 
216.98from bidding report -->
          </div>
          <div class="summary-card">
            <div class="summary-card__value">{{ propaneSummary.difference | number: '1.0-0' }}</div>
            <div class="summary-card__label">Difference with previous month price</div>
          </div>
          <div class="summary-card">
            <div class="summary-card__value">{{ propaneSummary.totalRk | number: '1.0-0' }}</div>
            <div class="summary-card__label">Total propane</div>
          </div>
        </div>
      </section>

      <!-- Butane Table -->
      <section class="product-section" *ngIf="awardTables.butane.dataSource.data.length">
        <div class="product-section__header">
          <h3 class="product-section__title">{{ awardTables.butane.label }}</h3>
        </div>
        <div
          class="table-container table-container--scrollable"
          [class.table-container--saving]="isSavingChanges"
        >
          <div class="table-saving-overlay" *ngIf="isSavingChanges">
            <mat-icon class="loading-icon" aria-hidden="true">autorenew</mat-icon>
            <span>Saving changes…</span>
          </div>
          <table
            mat-table
            [dataSource]="awardTables.butane.dataSource"
            class="app-data-table tender-table"
            matSort
            [matSortDisableClear]="true"
            #butaneSort="matSort"
          >
              <ng-container *ngFor="let column of awardsColumns" [matColumnDef]="column.key">
                <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
                <td mat-cell *matCellDef="let row">
                  <ng-container [ngSwitch]="column.key">
                    <ng-container *ngSwitchCase="'status'">
                      <button
                        type="button"
                        class="status-cell-btn"
                        (click)="openActiveStatusDialog(row)"
                        [disabled]="
                          isReadOnlyView ||
                          isStatusUpdating(row.id) ||
                          isPendingApprovalStatus
                        "
                      >
                        <mat-icon *ngIf="isStatusUpdating(row.id)" class="loading-icon">autorenew</mat-icon>
                        <span class="status-badge" [ngClass]="statusClass(row.status)">
                          {{ row.status || 'Set status' }}
                        </span>
                      </button>
                    </ng-container>
                    <span *ngSwitchCase="'bidVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <span *ngSwitchCase="'awardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <ng-container *ngSwitchCase="'finalAwardedVolume'">
                      <input
                        matInput
                        class="table-input"
                        type="number"
                        min="0"
                        [ngModel]="row.finalAwardedVolume ?? ''"
                        (ngModelChange)="onFinalAwardedVolumeChange(row, $event)"
                        [ngModelOptions]="{ standalone: true }"
                        [disabled]="isReadOnlyView || isPendingApprovalStatus"
                      />
                    </ng-container>
                    <span *ngSwitchCase="'bidPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <span *ngSwitchCase="'differentialPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <span *ngSwitchCase="'rankPerPrice'">{{ row[column.key] | number: '1.0-0' }}</span>
                    <span *ngSwitchCase="'rollingLiftFactor'">{{ row[column.key] | number: '1.2-2' }}</span>
                    <ng-container *ngSwitchCase="'comments'">
                      <textarea
                        matInput
                        class="table-textarea comment-textarea"
                        #activeCommentArea
                        [ngModel]="row.comments ?? ''"
                        (ngModelChange)="onCommentChange(row, $event)"
                        (input)="autoResizeTextarea(activeCommentArea)"
                        [ngModelOptions]="{ standalone: true }"
                        rows="2"
                        placeholder="Add comment"
                        [disabled]="isReadOnlyView || isPendingApprovalStatus"
                      ></textarea>
                    </ng-container>
                    <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
                  </ng-container>
                </td>
              </ng-container>

            <tr mat-header-row *matHeaderRowDef="awardsDisplayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: awardsDisplayedColumns"></tr>
          </table>
        </div>

        <!-- Butane Summary -->
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-card__value">{{ butaneSummary.totalVolume | number: '1.0-0' }}</div>
            <div class="summary-card__label">Sum of bid volume for butane</div>
          </div>
          <div class="summary-card">
            <div class="summary-card__value">{{ butaneSummary.weightedAverage | number: '1.0-0' }}</div>
            <div class="summary-card__label">Weighted average for butane</div>
          </div>
          <div class="summary-card summary-card--danger">
            <div class="summary-card__value">{{ butaneSummary.difference }}</div>
            <div class="summary-card__label">Difference with previous month price</div>
          </div>
          <div class="summary-card">
            <div class="summary-card__value">{{ butaneSummary.totalRk | number: '1.0-0' }}</div>
            <div class="summary-card__label">Total butane</div>
          </div>
        </div>
      </section>

      <!-- Statistics -->
      <div class="statistics-section">
        <div class="statistics-column statistics-left">
          <div class="stat-row">
            <div class="stat-box stat-box--success">
              <div class="stat-box__number">{{ statistics.invitedBuyers }}</div>
            </div>
            <div class="stat-box__label">
              Invited Buyers for {{ statistics.period }}
            </div>
          </div>

          <div class="stat-row">
            <div class="stat-box stat-box--warning">
              <div class="stat-box__number">{{ statistics.participatedBuyers }}</div>
            </div>
            <div class="stat-box__label">
              Participated Buyers
            </div>
          </div>
        </div>

        <div class="statistics-column statistics-right">
          <div class="stat-row">
            <div class="stat-box stat-box--info">
              <div class="stat-box__number">{{ statistics.totalBidVolume | number: '1.0-0' }}</div>
            </div>
            <div class="stat-box__label">
              Total LPG Bid Volume
            </div>
          </div>

          <div class="stat-row">
            <div class="stat-box stat-box--info">
              <div class="stat-box__number">{{ statistics.totalLpgForRk | number: '1.0-0' }}</div>
            </div>
            <div class="stat-box__label">
              Total Awarded LPR Volume
            </div>
          </div>

          <div class="stat-row">
            <div class="stat-box stat-box--neutral">
              <div class="stat-box__number">{{ statistics.weightedAverage | number: '1.0-0' }}</div>
            </div>
            <div class="stat-box__label">
               Weighted Average (Propane, Butane)
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <ng-container *ngIf="approvalAccessResolved; else actionAccessLoading">
        <ng-container *ngIf="isPendingApprovalStatus; else availableActions">
          <div class="action-buttons">
            <ng-container *ngIf="shouldShowApprovalButtons">
              <button
                type="button"
                class="action-btn"
                (click)="rejectReport()"
                *ngIf="isCommitteeMemberView && canPerformApprovalActions"
              >
                <mat-icon *ngIf="isApprovalActionInProgress('reject')" class="loading-icon">
                  autorenew
                </mat-icon>
                Reject
              </button>
              <button
                type="button"
                class="action-btn action-btn--primary"
                (click)="approveReport()"
                *ngIf="isCommitteeMemberView && canPerformApprovalActions"
              >
                <mat-icon *ngIf="isApprovalActionInProgress('approve')" class="loading-icon">
                  autorenew
                </mat-icon>
                Approve
              </button>
            </ng-container>
            <button
              type="button"
              class="action-btn"
              (click)="rollbackReport()"
              *ngIf="isPendingApprovalStatus && isLpgCoordinator"
            >
              <mat-icon *ngIf="isApprovalActionInProgress('rollback')" class="loading-icon">
                autorenew
              </mat-icon>
              Rollback
            </button>
          </div>
        </ng-container>

        <ng-template #availableActions>
          <div class="action-buttons">
            <div class="export-wrapper">
              <button
                type="button"
                class="action-btn"
                (click)="toggleExportMenu()"
              >
                Export
                <mat-icon class="dropdown-icon" [class.open]="showExportMenu">expand_more</mat-icon>
              </button>
              <div class="export-menu-container" *ngIf="showExportMenu">
                <div class="export-menu">
                  <button type="button" (click)="exportToExcel()">
                    <mat-icon>table_chart</mat-icon>
                    <span>Export to Excel</span>
                  </button>
                  <button type="button" (click)="exportToPDF()">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>Export to PDF</span>
                  </button>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="action-btn"
              (click)="openCommentsDialog()"
              [disabled]="isCommentsLoading"
            >
              <mat-icon *ngIf="isCommentsLoading" class="loading-icon">autorenew</mat-icon>
              Open Comments
            </button>
            <button
              type="button"
              class="action-btn"
              (click)="openManageApproversDialog()"
              *ngIf="isActiveStatus && isLpgCoordinator"
            >
              <mat-icon *ngIf="isManageApproversLoading" class="loading-icon">autorenew</mat-icon>
              Manage Approvers
            </button>
            <button
              type="button"
              class="action-btn action-btn--primary action-btn--send"
              (click)="openSendForApprovalDialog()"
              *ngIf="isActiveStatus && isLpgCoordinator"
            >
              <mat-icon *ngIf="isSendingForApproval" class="loading-icon">
                autorenew
              </mat-icon>
              <span>
                {{ isSendingForApproval ? 'Sending…' : 'Send for Approval' }}
              </span>
            </button>
          </div>
        </ng-template>
      </ng-container>

      <ng-template #actionAccessLoading>
        <div class="action-buttons">
          <button type="button" class="action-btn" disabled>
            <mat-icon class="loading-icon">autorenew</mat-icon>
            Loading actions…
          </button>
        </div>
      </ng-template>
    </ng-container>

    <ng-template #noActiveReportSelected>
      <mat-card class="material-card">
        <div class="history-state">Select a bidding report to view details</div>
      </mat-card>
    </ng-template>
  </div>
</ng-container>
