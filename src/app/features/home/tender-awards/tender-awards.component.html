<mat-card class="material-card awards-header">
  <div class="header-main">
    <div>
      <h2>Tender Award Analysis {{ selectedMonth }} {{ selectedYear }}</h2>
      <p>Creator: John Smith</p>
    </div>
    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="openProposalsDialog()"
        [disabled]="isLoadingProposals"
        [attr.aria-busy]="isLoadingProposals"
      >
        <mat-icon *ngIf="isLoadingProposals" class="loading-icon" aria-hidden="true">autorenew</mat-icon>
        <span>{{ isLoadingProposals ? 'Loadingâ€¦' : 'View Proposals' }}</span>
      </button>
      <button mat-stroked-button>
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>
  <div class="tab-row" role="tablist" aria-label="Tender award sections">
    <button
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'Initiate'"
      (click)="navigateToTab('Initiate')"
      role="tab"
      [attr.aria-selected]="activeTab === 'Initiate'"
    >
      Initiate
    </button>
    <button
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'History'"
      (click)="navigateToTab('History')"
      role="tab"
      [attr.aria-selected]="activeTab === 'History'"
    >
      History
    </button>
    <button
      type="button"
      class="tender-tab"
      [class.tender-tab--active]="activeTab === 'Active'"
      (click)="navigateToTab('Active')"
      role="tab"
      [attr.aria-selected]="activeTab === 'Active'"
    >
      Active
    </button>
  </div>
</mat-card>

<ng-container [ngSwitch]="activeTab">
  <mat-card *ngSwitchCase="'Initiate'" class="material-card initiate-card">
    <h3 class="initiate-title">Tender award analysis report details</h3>

    <div class="step-grid">
      <div class="step-card step-card--collect has-arrow">
        <span class="step-badge step-badge--blue">1</span>
        <h4>Data Collection</h4>
        <p>Gather all required documents and information needed for processing.</p>
        <button mat-raised-button color="primary">Start Collection</button>
      </div>

      <div class="step-card step-card--process has-arrow">
        <span class="step-badge step-badge--orange">2</span>
        <h4>Processing</h4>
        <p>Analyze and process the collected data through our system.</p>
        <span class="status-chip status-chip--processing">Processing</span>
      </div>

      <div class="step-card step-card--complete">
        <span class="step-badge step-badge--green">3</span>
        <h4>Completion</h4>
        <p>Review results and finalize the awarded nominations.</p>
        <span class="status-chip status-chip--complete">Complete</span>
      </div>
    </div>

    <p class="formula">
      Calculating Performance(%) = (Lifted PR + Lifted BT)/(Nominated PR + Nominated BT)
    </p>

    <mat-card class="material-card progress-card">
      <div class="progress-header">
        <strong>Current Progress</strong>
        <span class="progress-meta">Step 1 of 3</span>
      </div>
      <mat-progress-bar mode="determinate" value="33"></mat-progress-bar>
      <div class="progress-actions">
        <button mat-raised-button color="primary">Get Shipments</button>
        <button mat-stroked-button>Analyze History</button>
      </div>
    </mat-card>
  </mat-card>

  <mat-card *ngSwitchCase="'History'" class="material-card history-card">
    <h3>Historical Data</h3>
    <div class="app-table-card">
      <div class="table-container app-table-container">
        <table mat-table [dataSource]="historyDataSource" class="mat-elevation-z0 app-data-table" matSort #historySort="matSort">
        <ng-container *ngFor="let column of historyColumns" [matColumnDef]="column.key">
          <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
          <td mat-cell *matCellDef="let row">
            <ng-container [ngSwitch]="column.key">
              <span *ngSwitchCase="'status'" class="status-badge" [ngClass]="statusClass(row[column.key])">
                {{ row[column.key] }}
              </span>
              <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let row">
            <button mat-stroked-button color="primary" (click)="openStatusDialog(row, historyDataSource)">Change Status</button>
          </td>
        </ng-container>

          <tr mat-header-row *matHeaderRowDef="historyDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: historyDisplayedColumns"></tr>
        </table>
      </div>
    </div>
  </mat-card>

  <div *ngSwitchCase="'Active'" class="active-view">
    <ng-container *ngIf="currentReportId; else noActiveReportSelected">
      <mat-card class="material-card">
        <div class="app-table-card">
          <ng-container *ngIf="hasAwardData && !isLoadingDetails && !detailsLoadError; else detailsState">
            <div class="product-tables">
              <section
                class="product-table"
                *ngIf="awardTables.propane.dataSource.data.length; else noPropaneData"
                [class.product-table--collapsed]="!isTableExpanded('propane')"
              >
                <div class="product-table__header">
                  <h3 class="product-table__title">{{ awardTables.propane.label }}</h3>
                  <button
                    type="button"
                    class="product-table__toggle"
                    (click)="toggleTableExpansion('propane')"
                    [attr.aria-expanded]="isTableExpanded('propane')"
                  >
                    <mat-icon aria-hidden="true">
                      {{ isTableExpanded('propane') ? 'expand_less' : 'expand_more' }}
                    </mat-icon>
                    <span>{{ isTableExpanded('propane') ? 'Collapse' : 'Expand' }}</span>
                  </button>
                </div>
                <div
                  class="table-container app-table-container"
                  *ngIf="isTableExpanded('propane')"
                >
                  <table
                    mat-table
                    [dataSource]="awardTables.propane.dataSource"
                    class="mat-elevation-z0 app-data-table"
                    matSort
                    #propaneSort="matSort"
                  >
                    <ng-container *ngFor="let column of awardsColumns" [matColumnDef]="column.key">
                      <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
                      <td mat-cell *matCellDef="let row">
                        <ng-container [ngSwitch]="column.key">
                          <span *ngSwitchCase="'status'" class="status-badge" [ngClass]="statusClass(row[column.key])">
                            {{ row[column.key] }}
                          </span>
                          <span *ngSwitchCase="'bidVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'awardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'finalAwardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'bidPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <span *ngSwitchCase="'differentialPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <span *ngSwitchCase="'rankPerPrice'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'rollingLiftFactor'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <ng-container *ngSwitchCase="'comments'">
                            <div
                              class="comments-cell"
                              (click)="enableCommentEditing(row)"
                              (keydown.enter)="activateCommentEditing($event, row)"
                              (keydown.space)="activateCommentEditing($event, row)"
                              [class.is-editing]="isEditingComments(row)"
                              [attr.role]="isEditingComments(row) ? 'textbox' : 'button'"
                              [attr.tabindex]="isEditingComments(row) ? -1 : 0"
                              [attr.aria-label]="'Comments for ' + (row['bidder'] ?? 'record')"
                            >
                              <ng-container *ngIf="isEditingComments(row); else commentDisplayPropane">
                                <textarea
                                  matInput
                                  class="table-textarea"
                                  [ngModel]="row[column.key] ?? ''"
                                  (ngModelChange)="onCommentChange(row, $event)"
                                  (blur)="disableCommentEditing()"
                                  (click)="$event.stopPropagation()"
                                  (keydown.escape)="disableCommentEditing()"
                                  [attr.aria-label]="'Comments for ' + (row['bidder'] ?? 'record')"
                                ></textarea>
                              </ng-container>
                              <ng-template #commentDisplayPropane>
                                <span class="comments-readonly">
                                  {{ row[column.key] || 'Add comment' }}
                                </span>
                              </ng-template>
                            </div>
                          </ng-container>
                          <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
                        </ng-container>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef>Action</th>
                      <td mat-cell *matCellDef="let row">
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="openStatusDialog(row, awardTables.propane.dataSource)"
                        >
                          Change Status
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="awardsDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: awardsDisplayedColumns"></tr>
                  </table>
                </div>
              </section>
              <ng-template #noPropaneData>
                <section class="product-table product-table--empty">
                  <div class="product-table__header">
                    <h3 class="product-table__title">{{ awardTables.propane.label }}</h3>
                  </div>
                  <div class="history-state">No propane awards available.</div>
                </section>
              </ng-template>

              <section
                class="product-table"
                *ngIf="awardTables.butane.dataSource.data.length; else noButaneData"
                [class.product-table--collapsed]="!isTableExpanded('butane')"
              >
                <div class="product-table__header">
                  <h3 class="product-table__title">{{ awardTables.butane.label }}</h3>
                  <button
                    type="button"
                    class="product-table__toggle"
                    (click)="toggleTableExpansion('butane')"
                    [attr.aria-expanded]="isTableExpanded('butane')"
                  >
                    <mat-icon aria-hidden="true">
                      {{ isTableExpanded('butane') ? 'expand_less' : 'expand_more' }}
                    </mat-icon>
                    <span>{{ isTableExpanded('butane') ? 'Collapse' : 'Expand' }}</span>
                  </button>
                </div>
                <div
                  class="table-container app-table-container"
                  *ngIf="isTableExpanded('butane')"
                >
                  <table
                    mat-table
                    [dataSource]="awardTables.butane.dataSource"
                    class="mat-elevation-z0 app-data-table"
                    matSort
                    #butaneSort="matSort"
                  >
                    <ng-container *ngFor="let column of awardsColumns" [matColumnDef]="column.key">
                      <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">{{ column.label }}</th>
                      <td mat-cell *matCellDef="let row">
                        <ng-container [ngSwitch]="column.key">
                          <span *ngSwitchCase="'status'" class="status-badge" [ngClass]="statusClass(row[column.key])">
                            {{ row[column.key] }}
                          </span>
                          <span *ngSwitchCase="'bidVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'awardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'finalAwardedVolume'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'bidPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <span *ngSwitchCase="'differentialPrice'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <span *ngSwitchCase="'rankPerPrice'">{{ row[column.key] | number: '1.0-0' }}</span>
                          <span *ngSwitchCase="'rollingLiftFactor'">{{ row[column.key] | number: '1.2-2' }}</span>
                          <ng-container *ngSwitchCase="'comments'">
                            <div
                              class="comments-cell"
                              (click)="enableCommentEditing(row)"
                              (keydown.enter)="activateCommentEditing($event, row)"
                              (keydown.space)="activateCommentEditing($event, row)"
                              [class.is-editing]="isEditingComments(row)"
                              [attr.role]="isEditingComments(row) ? 'textbox' : 'button'"
                              [attr.tabindex]="isEditingComments(row) ? -1 : 0"
                              [attr.aria-label]="'Comments for ' + (row['bidder'] ?? 'record')"
                            >
                              <ng-container *ngIf="isEditingComments(row); else commentDisplayButane">
                                <textarea
                                  matInput
                                  class="table-textarea"
                                  [ngModel]="row[column.key] ?? ''"
                                  (ngModelChange)="onCommentChange(row, $event)"
                                  (blur)="disableCommentEditing()"
                                  (click)="$event.stopPropagation()"
                                  (keydown.escape)="disableCommentEditing()"
                                  [attr.aria-label]="'Comments for ' + (row['bidder'] ?? 'record')"
                                ></textarea>
                              </ng-container>
                              <ng-template #commentDisplayButane>
                                <span class="comments-readonly">
                                  {{ row[column.key] || 'Add comment' }}
                                </span>
                              </ng-template>
                            </div>
                          </ng-container>
                          <span *ngSwitchDefault>{{ valueFor(row, column.key) }}</span>
                        </ng-container>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef>Action</th>
                      <td mat-cell *matCellDef="let row">
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="openStatusDialog(row, awardTables.butane.dataSource)"
                        >
                          Change Status
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="awardsDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: awardsDisplayedColumns"></tr>
                  </table>
                </div>
              </section>
              <ng-template #noButaneData>
                <section class="product-table product-table--empty">
                  <div class="product-table__header">
                    <h3 class="product-table__title">{{ awardTables.butane.label }}</h3>
                  </div>
                  <div class="history-state">No butane awards available.</div>
                </section>
              </ng-template>
            </div>
          </ng-container>
          <ng-template #detailsState>
            <div class="history-state" [class.history-state--error]="detailsLoadError">
              <ng-container *ngIf="isLoadingDetails; else detailsStateMessage">
                Loading report detailsâ€¦
              </ng-container>
              <ng-template #detailsStateMessage>
                <ng-container *ngIf="detailsLoadError; else detailsEmpty">
                  Unable to load report details. Please try again later.
                </ng-container>
                <ng-template #detailsEmpty>
                  No details available for this report.
                </ng-template>
              </ng-template>
            </div>
          </ng-template>
        </div>
      </mat-card>

      <mat-card class="material-card kpi-strip" *ngIf="reportSummary as summary">
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.totalButaneVolume | number: '1.0-0' }}</div>
          <div class="kpi-label">Total Butane Volume</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.totalPropaneVolume | number: '1.0-0' }}</div>
          <div class="kpi-label">Total Propane Volume</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.weightedAvgButanePrice | number: '1.2-2' }}</div>
          <div class="kpi-label">Weighted Avg Butane Price</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.weightedAvgPropanePrice | number: '1.2-2' }}</div>
          <div class="kpi-label">Weighted Avg Propane Price</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.weightedTotalPrice === null ? 'â€”' : (summary.weightedTotalPrice | number: '1.2-2') }}</div>
          <div class="kpi-label">Weighted Total Price</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-value">{{ summary.totalVolume | number: '1.0-0' }}</div>
          <div class="kpi-label">Total Volume</div>
        </div>
      </mat-card>
    </ng-container>

    <ng-template #noActiveReportSelected>
      <mat-card class="material-card">
        <div class="history-state">Select a bidding report from the reports list to view active tender awards.</div>
      </mat-card>
    </ng-template>

    <div class="bottom-actions">
      <button mat-stroked-button>Calculate 12 months RLF</button>
      <button mat-stroked-button>Manage Signers</button>
      <button mat-stroked-button>Export to Excel</button>
      <button mat-stroked-button>Export to PDF</button>
      <button mat-stroked-button>Open & Download</button>
      <button mat-stroked-button color="warn">Delete PDF</button>
      <button
        mat-raised-button
        color="primary"
        (click)="openSendForApprovalDialog()"
        [disabled]="!currentReportId || isLoadingApprovers || isSendingForApproval"
        [attr.aria-busy]="isLoadingApprovers || isSendingForApproval"
      >
        <mat-icon
          *ngIf="isLoadingApprovers || isSendingForApproval"
          class="loading-icon"
          aria-hidden="true"
        >
          autorenew
        </mat-icon>
        <span>
          {{
            isSendingForApproval
              ? 'Sendingâ€¦'
              : isLoadingApprovers
                ? 'Loading approversâ€¦'
                : 'Send for Approval'
          }}
        </span>
      </button>
      <button mat-stroked-button color="primary" (click)="openManageBiddersDialog()">Manage Bidders</button>
    </div>

  </div>
</ng-container>
