<form [formGroup]="form" class="formFieldSubscriptWrapperPositionAbsolute">
  <div id="table-scroll">
    <table mat-table [dataSource]="dataSourceSectionE1" aria-label="Products">
      <ng-container formArrayName="products">
        <ng-container matColumnDef="number">
          <th scope="col" mat-header-cell *matHeaderCellDef>№ п/п</th>
          <td class="row-value" mat-cell *matCellDef="let element;let i = index;"> {{i+1}} </td>
        </ng-container>
  
        <ng-container matColumnDef="name">
          <th scope="col" mat-header-cell *matHeaderCellDef>Наименование товаров, работ, услуг</th>
          <td class="row-value" mat-cell *matCellDef="let element;let i = index;">
            {{element.get('name').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="compositeGsvsCode">
          <th scope="col" mat-header-cell *matHeaderCellDef>Составной код ГСВС</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('compositeGsvsCode').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="truOriginCode">
          <th scope="col" mat-header-cell *matHeaderCellDef>Признак происхождения товаров, работ, услуг</th>
          <td class="row-value" mat-cell *matCellDef="let element; let i=index" [formGroupName]="i">
            <mat-form-field appearance="fill">
              <mat-select formControlName="truOriginCode">
                <mat-option *ngFor="let code of truOriginCodes" [value]="code.value">
                  {{code.viewValue }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="element.get('truOriginCode').hasError('required')">
                Признак происхождения товара отсутствует
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="id">
          <th scope="col" mat-header-cell *matHeaderCellDef>Идентификатор товара</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('id').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="codeTNVED">
          <th scope="col" mat-header-cell *matHeaderCellDef>Код ТН ВЭД ЕАЭС</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('codeTNVED').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="dutyType">
          <th scope="col" mat-header-cell *matHeaderCellDef>Тип пошлины</th>
          <td class="row-value" mat-cell *matCellDef="let element; let i=index" [formGroupName]="i">
            <mat-form-field appearance="fill">
              <mat-select formControlName="dutyType">
                <mat-option *ngFor="let dutyType of dutyTypes" [value]="dutyType.value">
                  {{dutyType.viewValue}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="element.get('dutyType').hasError('required')">
                Тип пошлины товара отсутствует
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="unitOfMeasurement">
          <th scope="col" mat-header-cell *matHeaderCellDef>Единица измерения</th>

          <td class="row-value" mat-cell *matCellDef="let element; let i=index" [formGroupName]="i">
            <mat-form-field appearance="fill" floatLabel="always">
              <app-auto-complete-search-uom
                formControlName="unitOfMeasurement"
              >
              </app-auto-complete-search-uom>
              <mat-error *ngIf="element.get('unitOfMeasurement').hasError('required')">
                Единицы измерения товара отсутствует
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="quantity">
          <th scope="col" mat-header-cell *matHeaderCellDef>Количество (объем)</th>
          <td class="row-value" mat-cell *matCellDef="let element; let i=index" [formGroupName]="i">
            <mat-form-field appearance="fill">
              <input matInput restrictedDecimals type="number" formControlName="quantity" />
              <mat-error *ngIf="element.get('quantity').hasError('required')">Поле является обязательным для заполнения</mat-error>
              <mat-error *ngIf="element.get('quantity').hasError('positiveNumber') && !element.get('quantity').hasError('required')">
                Поле не может быть отрицательным
              </mat-error>
              <mat-error *ngIf="element.get('quantity').hasError('max')">
                Недостаточно товаров на складе
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="manufactureOrImportCountry">
          <th scope="col" mat-header-cell *matHeaderCellDef>Страна</th>
          <td class="row-value" mat-cell *matCellDef="let element; let i=index" [formGroupName]="i">
            <mat-form-field appearance="fill">
              <app-auto-complete-search-country
                [countrySearchAmount]="0"
                formControlName="manufactureOrImportCountry"
              ></app-auto-complete-search-country>
              <mat-error *ngIf="element.get('manufactureOrImportCountry').hasError('required')">
                Поле является обязательным для заполнения
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="manufactureOrImportDocNumber">
          <th scope="col" mat-header-cell *matHeaderCellDef>№ документа производства/импорта (ДТ, ФНО 328.00, CT-KZ, CT-1)</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('manufactureOrImportDocNumber').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="productNumberInImportDoc">
          <th scope="col" mat-header-cell *matHeaderCellDef>Номер товарной позиции из документа импорта (ДТ или ФНО 328.00)</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('productNumberInImportDoc').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="productNameInImportDoc">
          <th scope="col" mat-header-cell *matHeaderCellDef>Наименование товаров в соответствии с документом импорта (ДТ или ФНО 328.00)</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('productNameInImportDoc').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="price">
          <th scope="col" mat-header-cell *matHeaderCellDef>Цена за единицу</th>
          <td class="row-value" mat-cell *matCellDef="let element; let i=index;" [formGroupName]="i">
            <mat-form-field appearance="fill">
              <input matInput restrictedDecimals type="number" formControlName="price" />
              <mat-error *ngIf="element.get('price').hasError('required')">Поле является обязательным для заполнения</mat-error>
              <mat-error *ngIf="element.get('price').hasError('positiveNumber') && !element.get('price').hasError('required')">
                Поле не может быть отрицательным
              </mat-error>
            </mat-form-field>
          </td>
        </ng-container>
  
        <ng-container matColumnDef="sum">
          <th scope="col" mat-header-cell *matHeaderCellDef>Сумма</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{(element.get('price')?.value * element.get('quantity')?.value) | number: '1.0-6'}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="pinCode">
          <th scope="col" mat-header-cell *matHeaderCellDef>Пин-код</th>
          <td class="row-value" mat-cell *matCellDef="let element">
            {{element.get('pinCode').value}}
          </td>
        </ng-container>
  
        <ng-container matColumnDef="add" *ngIf="mode !== formActionMode.Show">
          <th scope="col" mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element; let i = index;">
            <button class="product-action-button" mat-raised-button (click)="removeProduct(i)">x</button>
          </td>
        </ng-container>
      </ng-container>
      <ng-container *ngFor="let headerNumber of numberHeaderRowDefs; let i = index" matColumnDef="{{headerNumber}}">
        <th scope="col" mat-header-cell *matHeaderCellDef>
          <span *ngIf="i==numberHeaderRowDefs.length-1 && mode !== formActionMode.Show; else iteration">
            <button class="product-action-button" mat-raised-button (click)="addProduct()" [disabled]="isAddProductButtonDisabled()">+</button>
          </span>
          <ng-template #iteration>
            <span>{{i+1}}</span>
          </ng-template>
        </th>
      </ng-container>
  
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-header-row *matHeaderRowDef="numberHeaderRowDefs"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  
    </table>
  </div>
</form>